name: Build and Release Soju (Source Build)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      wine_version:
        description: 'Wine version to build (e.g., 11.0-rc5)'
        required: false
        default: ''

env:
  # Component versions
  DXMT_VERSION: 'v0.72'
  DXVK_VERSION: 'v2.7.1'
  WINE_MONO_VERSION: '10.4.1'
  WINE_GECKO_VERSION: '2.47.4'
  WINETRICKS_VERSION: '20250102'

  # Build environment (crossover-wine-ci style)
  CC: ccache clang -arch x86_64
  CXX: ccache clang++ -arch x86_64
  i386_CC: ccache i686-w64-mingw32-gcc
  x86_64_CC: ccache x86_64-w64-mingw32-gcc
  CFLAGS: -O2
  CROSSCFLAGS: -O2 -Wno-error=incompatible-pointer-types
  LDFLAGS: -Wl,-headerpad_max_install_names -Wl,-rpath,@loader_path/../../ -Wl,-rpath,/usr/local/lib
  MACOSX_DEPLOYMENT_TARGET: '10.15'

  # Build paths
  WINE_CONFIGURE: ${{ github.workspace }}/wine-source/configure
  BUILDROOT: ${{ github.workspace }}/build
  WINE_INSTALLROOT: ${{ github.workspace }}/wine-install

  # ccache settings
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: '4G'
  CCACHE_COMPILERCHECK: content

jobs:
  build:
    name: Build Wine from Source
    runs-on: macos-15-intel  # Intel x86_64 for native library support
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Read VERSION file
        id: version
        run: |
          # Read version from VERSION file
          if [ -f "VERSION" ]; then
            WINE_VERSION=$(cat VERSION | tr -d '[:space:]')
            echo "Read Wine version from VERSION file: $WINE_VERSION"
          else
            echo "ERROR: VERSION file not found"
            exit 1
          fi

          # Override with workflow input if provided
          if [ -n "${{ github.event.inputs.wine_version }}" ]; then
            WINE_VERSION="${{ github.event.inputs.wine_version }}"
            echo "Overridden with workflow input: $WINE_VERSION"
          fi

          echo "wine_version=$WINE_VERSION" >> "$GITHUB_OUTPUT"

          # Parse version components
          MAJOR=$(echo "$WINE_VERSION" | sed -E 's/([0-9]+)\..*/\1/')
          MINOR=$(echo "$WINE_VERSION" | sed -E 's/[0-9]+\.([0-9]+).*/\1/')
          PRERELEASE=$(echo "$WINE_VERSION" | sed -E 's/.*-(rc[0-9]+).*/\1/' | grep -E '^rc' || echo "")

          echo "major=$MAJOR" >> "$GITHUB_OUTPUT"
          echo "minor=$MINOR" >> "$GITHUB_OUTPUT"
          echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"

          echo "============================================"
          echo "Wine Version: $WINE_VERSION"
          echo "Major: $MAJOR, Minor: $MINOR, Prerelease: $PRERELEASE"
          echo "============================================"

      - name: Install build dependencies (Homebrew)
        run: |
          # Install Homebrew dependencies for Wine build (crossover-wine-ci style)
          brew install \
            bison \
            ccache \
            flex \
            gettext \
            mingw-w64 \
            pkg-config

          # Add bison and flex to PATH (Homebrew versions required)
          echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
          echo "$(brew --prefix ccache)/libexec" >> $GITHUB_PATH

      - name: Install runtime dependencies (Homebrew)
        run: |
          # Install runtime libraries
          brew install \
            freetype \
            gnutls \
            nettle \
            p11-kit \
            libtasn1 \
            libidn2 \
            libunistring \
            libusb \
            molten-vk \
            sdl2 \
            sdl3 \
            faudio \
            icu4c \
            libiconv \
            gettext \
            libxml2 \
            libxslt \
            zstd \
            xz \
            lz4 \
            brotli \
            libffi \
            gmp \
            libpcap \
            gstreamer \
            gst-plugins-base \
            gst-plugins-good

      - name: Verify runtime libraries exist
        run: |
          echo "Verifying runtime libraries before build..."
          HOMEBREW_LIB="/usr/local/lib"
          MISSING=0

          # Critical libraries that must exist
          CRITICAL_LIBS=(
            "libfreetype.6.dylib"
            "libpng16.16.dylib"
            "libgnutls.30.dylib"
            "libMoltenVK.dylib"
            "libSDL2-2.0.0.dylib"
          )

          for lib in "${CRITICAL_LIBS[@]}"; do
            if [ ! -f "$HOMEBREW_LIB/$lib" ]; then
              FOUND=$(find /usr/local/Cellar -name "$lib" 2>/dev/null | head -1)
              if [ -z "$FOUND" ]; then
                echo "MISSING: $lib"
                MISSING=$((MISSING + 1))
              else
                echo "OK (Cellar): $lib"
              fi
            else
              echo "OK: $lib"
            fi
          done

          # Check ICU (any version)
          ICU_PATH="/usr/local/opt/icu4c/lib"
          if [ ! -d "$ICU_PATH" ]; then
            ICU_PATH="/opt/homebrew/opt/icu4c/lib"
          fi
          if [ -d "$ICU_PATH" ] && ls "$ICU_PATH"/libicuuc.*.dylib 1>/dev/null 2>&1; then
            echo "OK: ICU libraries found in $ICU_PATH"
          else
            echo "MISSING: ICU libraries"
            MISSING=$((MISSING + 1))
          fi

          if [ $MISSING -gt 0 ]; then
            echo "ERROR: $MISSING critical libraries missing. Aborting before build."
            exit 1
          fi
          echo "All critical libraries verified."

      - name: Get Wine fork commit
        id: wine_commit
        run: |
          # Get wine-fork commit hash for cache key (before ccache setup)
          WINE_COMMIT=$(curl -s "https://api.github.com/repos/PodoSoju/wine/commits/soju-window-identifier" | grep '"sha"' | head -1 | cut -d'"' -f4)
          echo "Wine fork commit: $WINE_COMMIT"
          echo "commit=$WINE_COMMIT" >> "$GITHUB_OUTPUT"

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-wine-${{ steps.version.outputs.wine_version }}-${{ steps.wine_commit.outputs.commit }}
          restore-keys: |
            ccache-wine-${{ steps.version.outputs.wine_version }}-${{ steps.wine_commit.outputs.commit }}

      - name: Initialize ccache
        run: |
          ccache --zero-stats
          ccache --max-size=${{ env.CCACHE_MAXSIZE }}
          ccache --show-config

      - name: Download Wine source
        id: download
        run: |
          WINE_VERSION="${{ steps.version.outputs.wine_version }}"
          WINE_SOURCE_DIR="${{ github.workspace }}/wine-source"

          echo "Downloading Wine ${WINE_VERSION} source from GitHub mirror..."

          # Download from PodoSoju fork with SOJU_EXE_PATH patch
          WINE_URL="https://github.com/PodoSoju/wine/archive/refs/heads/soju-window-identifier.tar.gz"
          echo "Download URL: $WINE_URL"

          # Download with retry logic
          MAX_RETRIES=3
          RETRY_DELAY=10
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Download attempt $i of $MAX_RETRIES..."
            if curl -fsSL -o wine-source.tar.gz "$WINE_URL"; then
              echo "Download successful"
              break
            else
              if [ $i -eq $MAX_RETRIES ]; then
                echo "ERROR: Failed to download Wine source after $MAX_RETRIES attempts"
                exit 1
              fi
              echo "Download failed, retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          # Extract source
          mkdir -p "$WINE_SOURCE_DIR"
          tar -xzf wine-source.tar.gz -C "$WINE_SOURCE_DIR" --strip-components=1
          rm wine-source.tar.gz

          echo "source_dir=$WINE_SOURCE_DIR" >> "$GITHUB_OUTPUT"
          echo "Wine source extracted to: $WINE_SOURCE_DIR"

      - name: Verify patches (already in fork)
        run: |
          WINE_SOURCE_DIR="${{ steps.download.outputs.source_dir }}"
          echo "Using PodoSoju/wine fork with patches pre-applied"
          echo "Checking for SOJU_EXE_PATH in cocoa_window.m..."
          grep -n "SOJU_EXE_PATH" "$WINE_SOURCE_DIR/dlls/winemac.drv/cocoa_window.m" || {
            echo "ERROR: SOJU_EXE_PATH patch not found!"
            exit 1
          }
          echo "Patch verified successfully"

      - name: Configure Wine (crossover-wine-ci style)
        run: |
          WINE_SOURCE_DIR="${{ steps.download.outputs.source_dir }}"

          mkdir -p "${{ env.BUILDROOT }}/wine64"
          cd "${{ env.BUILDROOT }}/wine64"

          # Configure with crossover-wine-ci style options (x86_64 only)
          "$WINE_SOURCE_DIR/configure" \
            --build=x86_64-apple-darwin \
            --prefix= \
            --disable-tests \
            --enable-archs=i386,x86_64 \
            --without-alsa \
            --without-capi \
            --with-coreaudio \
            --with-cups \
            --without-dbus \
            --without-ffmpeg \
            --without-fontconfig \
            --with-freetype \
            --with-gettext \
            --without-gettextpo \
            --without-gphoto \
            --with-gnutls \
            --without-gssapi \
            --with-gstreamer \
            --without-krb5 \
            --with-mingw \
            --without-netapi \
            --with-opencl \
            --without-opengl \
            --without-oss \
            --with-pcap \
            --with-pthread \
            --without-pulse \
            --without-sane \
            --with-sdl \
            --without-udev \
            --with-unwind \
            --without-usb \
            --without-v4l2 \
            --with-vulkan \
            --without-wayland \
            --without-x

      - name: Build Wine
        run: |
          cd "${{ env.BUILDROOT }}/wine64"

          NPROC=$(sysctl -n hw.ncpu 2>/dev/null)
          echo "Building with $NPROC parallel jobs..."
          make -j$NPROC

      - name: Install Wine
        run: |
          cd "${{ env.BUILDROOT }}/wine64"

          echo "Installing Wine..."
          make install-lib DESTDIR="${{ env.WINE_INSTALLROOT }}"

          echo "Wine build complete"

          # Verify installation
          if [ -f "${{ env.WINE_INSTALLROOT }}/bin/wine64" ]; then
            "${{ env.WINE_INSTALLROOT }}/bin/wine64" --version || true
          fi

      - name: Show ccache stats
        run: |
          ccache --show-stats

      - name: Bundle runtime libraries
        run: |
          echo "Bundling Homebrew runtime libraries..."
          WINE_LIB="${{ env.WINE_INSTALLROOT }}/lib"
          mkdir -p "$WINE_LIB"

          # Copy essential runtime libraries from Homebrew
          HOMEBREW_LIB="/usr/local/lib"  # Intel Homebrew path

          LIBS=(
            # Font rendering
            "libfreetype.6.dylib"
            "libpng16.16.dylib"
            # Encryption/TLS (gnutls and dependencies)
            "libgnutls.30.dylib"
            "libgnutlsxx.30.dylib"
            "libnettle.8.dylib"
            "libhogweed.6.dylib"
            "libtasn1.6.dylib"
            "libp11-kit.0.dylib"
            "libidn2.0.dylib"
            "libunistring.5.dylib"
            # Graphics
            "libMoltenVK.dylib"
            # Audio
            "libSDL2-2.0.0.dylib"
            "libSDL3.0.dylib"
            "libFAudio.0.dylib"
            # Unicode/i18n (ICU) - dynamically detected below
            # Character encoding
            "libiconv.2.dylib"
            "libintl.8.dylib"
            "libcharset.1.dylib"
            # XML
            "libxml2.2.dylib"
            "libxslt.1.dylib"
            "libexslt.0.dylib"
            # Compression
            "libbrotlidec.1.dylib"
            "libbrotlicommon.1.dylib"
            "libbrotlienc.1.dylib"
            "libzstd.1.dylib"
            "liblzma.5.dylib"
            "liblz4.1.dylib"
            "libz.1.dylib"
            "libbz2.1.dylib"
            # Misc
            "libffi.8.dylib"
            "libgmp.10.dylib"
            "libgmpxx.4.dylib"
            "libpcap.1.dylib"
          )

          for lib in "${LIBS[@]}"; do
            # Skip if already copied
            if [ -f "$WINE_LIB/$lib" ]; then
              echo "  Already exists: $lib"
              continue
            fi

            if [ -f "$HOMEBREW_LIB/$lib" ]; then
              cp -f "$HOMEBREW_LIB/$lib" "$WINE_LIB/" 2>/dev/null || true
              echo "  Copied: $lib"
            else
              # Try to find in Homebrew cellar
              FOUND=$(find /usr/local/Cellar -name "$lib" 2>/dev/null | head -1)
              if [ -n "$FOUND" ]; then
                cp -f "$FOUND" "$WINE_LIB/" 2>/dev/null || true
                echo "  Copied from Cellar: $lib"
              else
                echo "  WARNING: $lib not found"
              fi
            fi
          done

          # Copy ICU libraries dynamically (version-agnostic)
          echo "Copying ICU libraries..."
          ICU_PATH="/usr/local/opt/icu4c/lib"
          if [ ! -d "$ICU_PATH" ]; then
            ICU_PATH="/opt/homebrew/opt/icu4c/lib"
          fi
          if [ -d "$ICU_PATH" ]; then
            for iculib in "$ICU_PATH"/libicu*.dylib; do
              if [ -f "$iculib" ] && [ ! -L "$iculib" ]; then
                cp -f "$iculib" "$WINE_LIB/" 2>/dev/null && echo "  Copied: $(basename $iculib)" || true
              fi
            done
          else
            echo "  WARNING: ICU library path not found"
          fi

          # MoltenVK already copied in LIBS array above

          echo "Runtime libraries bundled"
          ls -la "$WINE_LIB/"*.dylib 2>/dev/null | head -20 || true

          # Fix library paths for portability
          echo "Fixing library paths..."
          WINE_BIN="${{ env.WINE_INSTALLROOT }}/bin"
          for binary in "$WINE_BIN"/*; do
            if file "$binary" | grep -q "Mach-O"; then
              # Add rpath to find libraries in ../lib
              install_name_tool -add_rpath @executable_path/../lib "$binary" 2>/dev/null || true
            fi
          done

          # Fix dylib references in libraries
          for dylib in "$WINE_LIB"/*.dylib; do
            if [ -f "$dylib" ]; then
              # Change ID to @rpath
              install_name_tool -id "@rpath/$(basename $dylib)" "$dylib" 2>/dev/null || true
            fi
          done
          echo "Library paths fixed"

      - name: Download DXMT
        id: dxmt
        run: |
          DXMT_VERSION="${{ env.DXMT_VERSION }}"
          DXMT_URL="https://github.com/3Shain/dxmt/releases/download/${DXMT_VERSION}/dxmt-${DXMT_VERSION}-builtin.tar.gz"
          DXMT_DIR="${{ github.workspace }}/dxmt"

          echo "Downloading DXMT ${DXMT_VERSION}..."

          # Download with retry
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -fsSL -o dxmt.tar.gz "$DXMT_URL"; then
              break
            fi
            if [ $i -eq $MAX_RETRIES ]; then
              echo "ERROR: Failed to download DXMT"
              exit 1
            fi
            sleep 5
          done

          mkdir -p "$DXMT_DIR"
          tar -xzf dxmt.tar.gz -C "$DXMT_DIR"
          rm dxmt.tar.gz

          echo "dir=$DXMT_DIR" >> "$GITHUB_OUTPUT"

      - name: Download DXVK
        id: dxvk
        run: |
          DXVK_VERSION="${{ env.DXVK_VERSION }}"
          DXVK_URL="https://github.com/doitsujin/dxvk/releases/download/${DXVK_VERSION}/dxvk-${DXVK_VERSION#v}.tar.gz"
          DXVK_DIR="${{ github.workspace }}/dxvk"

          echo "Downloading DXVK ${DXVK_VERSION}..."

          # Download with retry
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -fsSL -o dxvk.tar.gz "$DXVK_URL"; then
              break
            fi
            if [ $i -eq $MAX_RETRIES ]; then
              echo "ERROR: Failed to download DXVK"
              exit 1
            fi
            sleep 5
          done

          mkdir -p "$DXVK_DIR"
          tar -xzf dxvk.tar.gz -C "$DXVK_DIR" --strip-components=1
          rm dxvk.tar.gz

          echo "dir=$DXVK_DIR" >> "$GITHUB_OUTPUT"

      - name: Download Wine Mono
        id: mono
        run: |
          MONO_VERSION="${{ env.WINE_MONO_VERSION }}"
          MONO_URL="https://github.com/madewokherd/wine-mono/releases/download/wine-mono-${MONO_VERSION}/wine-mono-${MONO_VERSION}-x86.tar.xz"
          MONO_DIR="${{ github.workspace }}/wine-mono"

          echo "Downloading Wine Mono ${MONO_VERSION}..."

          # Download with retry
          MAX_RETRIES=3
          for i in $(seq 1 $MAX_RETRIES); do
            if curl -fsSL -o wine-mono.tar.xz "$MONO_URL"; then
              break
            fi
            if [ $i -eq $MAX_RETRIES ]; then
              echo "ERROR: Failed to download Wine Mono"
              exit 1
            fi
            sleep 5
          done

          mkdir -p "$MONO_DIR"
          tar -xJf wine-mono.tar.xz -C "$MONO_DIR"
          rm wine-mono.tar.xz

          echo "dir=$MONO_DIR" >> "$GITHUB_OUTPUT"

      - name: Download Wine Gecko
        id: gecko
        run: |
          GECKO_VERSION="${{ env.WINE_GECKO_VERSION }}"
          GECKO_DIR="${{ github.workspace }}/wine-gecko"
          mkdir -p "$GECKO_DIR"

          echo "Downloading Wine Gecko ${GECKO_VERSION}..."

          # Download both x86 and x86_64 versions
          for arch in x86 x86_64; do
            GECKO_URL="https://dl.winehq.org/wine/wine-gecko/${GECKO_VERSION}/wine-gecko-${GECKO_VERSION}-${arch}.tar.xz"
            echo "Downloading $arch..."

            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
              if curl -fsSL -o "gecko-${arch}.tar.xz" "$GECKO_URL"; then
                break
              fi
              if [ $i -eq $MAX_RETRIES ]; then
                echo "WARNING: Failed to download Gecko $arch"
              fi
              sleep 5
            done

            if [ -f "gecko-${arch}.tar.xz" ]; then
              tar -xJf "gecko-${arch}.tar.xz" -C "$GECKO_DIR"
              rm "gecko-${arch}.tar.xz"
            fi
          done

          echo "dir=$GECKO_DIR" >> "$GITHUB_OUTPUT"

      - name: Download Winetricks
        run: |
          WINETRICKS_VERSION="${{ env.WINETRICKS_VERSION }}"

          # Download from raw source (release asset not available)
          echo "Downloading Winetricks ${WINETRICKS_VERSION}..."
          curl -fsSL -o winetricks "https://raw.githubusercontent.com/Winetricks/winetricks/${WINETRICKS_VERSION}/src/winetricks"
          chmod +x winetricks

      - name: Package Soju
        id: package
        run: |
          WINE_INSTALL_DIR="${{ env.WINE_INSTALLROOT }}"
          DXMT_DIR="${{ steps.dxmt.outputs.dir }}"
          DXVK_DIR="${{ steps.dxvk.outputs.dir }}"
          OUTPUT_DIR="${{ github.workspace }}/dist"

          WINE_VERSION="${{ steps.version.outputs.wine_version }}"
          MAJOR="${{ steps.version.outputs.major }}"
          MINOR="${{ steps.version.outputs.minor }}"
          PRERELEASE="${{ steps.version.outputs.prerelease }}"

          echo "Packaging Soju..."

          # Create output structure
          rm -rf "$OUTPUT_DIR"
          mkdir -p "$OUTPUT_DIR/Libraries/Soju"

          # Copy Wine binaries and libraries
          cp -R "$WINE_INSTALL_DIR/bin" "$OUTPUT_DIR/Libraries/Soju/"
          cp -R "$WINE_INSTALL_DIR/lib" "$OUTPUT_DIR/Libraries/Soju/"
          cp -R "$WINE_INSTALL_DIR/share" "$OUTPUT_DIR/Libraries/Soju/"
          chmod +x "$OUTPUT_DIR/Libraries/Soju/bin/"*

          # Integrate DXMT (x64 + x32)
          mkdir -p "$OUTPUT_DIR/Libraries/Soju/lib/wine/x86_64-windows"
          mkdir -p "$OUTPUT_DIR/Libraries/Soju/lib/wine/i386-windows"
          if [ -d "$DXMT_DIR/x64" ]; then
            cp "$DXMT_DIR/x64/"*.dll "$OUTPUT_DIR/Libraries/Soju/lib/wine/x86_64-windows/" 2>/dev/null || true
            echo "DXMT x64 integrated"
          fi
          if [ -d "$DXMT_DIR/x32" ]; then
            cp "$DXMT_DIR/x32/"*.dll "$OUTPUT_DIR/Libraries/Soju/lib/wine/i386-windows/" 2>/dev/null || true
            echo "DXMT x32 integrated"
          fi

          # Integrate DXVK (x64 + x32)
          if [ -d "$DXVK_DIR/x64" ]; then
            cp "$DXVK_DIR/x64/"*.dll "$OUTPUT_DIR/Libraries/Soju/lib/wine/x86_64-windows/" 2>/dev/null || true
            echo "DXVK x64 integrated"
          fi
          if [ -d "$DXVK_DIR/x32" ]; then
            cp "$DXVK_DIR/x32/"*.dll "$OUTPUT_DIR/Libraries/Soju/lib/wine/i386-windows/" 2>/dev/null || true
            echo "DXVK x32 integrated"
          fi

          # Copy CJK fonts
          FONTS_DIR="${{ github.workspace }}/fonts"
          if [ -d "$FONTS_DIR" ]; then
            mkdir -p "$OUTPUT_DIR/Libraries/Soju/share/wine/fonts"
            cp "$FONTS_DIR"/*.TTC "$OUTPUT_DIR/Libraries/Soju/share/wine/fonts/" 2>/dev/null || true
            cp "$FONTS_DIR"/*.ttc "$OUTPUT_DIR/Libraries/Soju/share/wine/fonts/" 2>/dev/null || true
            cp "$FONTS_DIR"/OFL-*.txt "$OUTPUT_DIR/Libraries/Soju/share/wine/fonts/" 2>/dev/null || true
            echo "CJK fonts added"
          fi

          # Copy Wine Mono
          MONO_DIR="${{ steps.mono.outputs.dir }}"
          if [ -d "$MONO_DIR" ]; then
            mkdir -p "$OUTPUT_DIR/Libraries/Soju/share/wine/mono"
            cp -R "$MONO_DIR"/* "$OUTPUT_DIR/Libraries/Soju/share/wine/mono/"
            echo "Wine Mono integrated"
          fi

          # Copy Wine Gecko
          GECKO_DIR="${{ steps.gecko.outputs.dir }}"
          if [ -d "$GECKO_DIR" ]; then
            mkdir -p "$OUTPUT_DIR/Libraries/Soju/share/wine/gecko"
            cp -R "$GECKO_DIR"/* "$OUTPUT_DIR/Libraries/Soju/share/wine/gecko/"
            echo "Wine Gecko integrated"
          fi

          # Copy Winetricks
          if [ -f "${{ github.workspace }}/winetricks" ]; then
            cp "${{ github.workspace }}/winetricks" "$OUTPUT_DIR/Libraries/Soju/bin/"
            chmod +x "$OUTPUT_DIR/Libraries/Soju/bin/winetricks"
            echo "Winetricks integrated"
          fi

          # Generate SojuVersion.plist
          cat > "$OUTPUT_DIR/Libraries/SojuVersion.plist" << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>version</key>
              <dict>
                  <key>major</key>
                  <integer>$MAJOR</integer>
                  <key>minor</key>
                  <integer>$MINOR</integer>
                  <key>patch</key>
                  <integer>0</integer>
                  <key>preRelease</key>
                  <string>$PRERELEASE</string>
                  <key>build</key>
                  <string>source</string>
              </dict>
              <key>components</key>
              <dict>
                  <key>wine</key>
                  <string>${WINE_VERSION}</string>
                  <key>dxmt</key>
                  <string>${DXMT_VERSION}</string>
                  <key>dxvk</key>
                  <string>${DXVK_VERSION}</string>
              </dict>
              <key>buildInfo</key>
              <dict>
                  <key>buildType</key>
                  <string>source</string>
                  <key>buildDate</key>
                  <string>$(date -u +"%Y-%m-%dT%H:%M:%SZ")</string>
                  <key>commit</key>
                  <string>${GITHUB_SHA}</string>
              </dict>
          </dict>
          </plist>
          PLIST

          # Create tarball
          cd "$OUTPUT_DIR"
          if [ -n "$PRERELEASE" ]; then
            TARBALL_NAME="Soju-${MAJOR}.${MINOR}-${PRERELEASE}.tar.gz"
          else
            TARBALL_NAME="Soju-${MAJOR}.${MINOR}.0.tar.gz"
          fi
          tar -czf "$TARBALL_NAME" Libraries
          rm -rf Libraries

          echo "tarball_name=$TARBALL_NAME" >> "$GITHUB_OUTPUT"
          echo "tarball_path=$OUTPUT_DIR/$TARBALL_NAME" >> "$GITHUB_OUTPUT"

          echo "============================================"
          echo "Package complete: $TARBALL_NAME"
          echo "============================================"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: soju-build
          path: dist/*.tar.gz
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ${{ env.BUILDROOT }}/wine64/config.log
            ${{ env.CCACHE_DIR }}/stats
          retention-days: 3

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read VERSION file
        id: version
        run: |
          WINE_VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "wine_version=$WINE_VERSION" >> "$GITHUB_OUTPUT"

          # Parse for display
          MAJOR=$(echo "$WINE_VERSION" | sed -E 's/([0-9]+)\..*/\1/')
          MINOR=$(echo "$WINE_VERSION" | sed -E 's/[0-9]+\.([0-9]+).*/\1/')
          PRERELEASE=$(echo "$WINE_VERSION" | sed -E 's/.*-(rc[0-9]+).*/\1/' | grep -E '^rc' || echo "")

          if [ -n "$PRERELEASE" ]; then
            echo "display_version=${MAJOR}.${MINOR}-${PRERELEASE}" >> "$GITHUB_OUTPUT"
          else
            echo "display_version=${MAJOR}.${MINOR}.0" >> "$GITHUB_OUTPUT"
          fi

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: soju-build
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Soju ${{ steps.version.outputs.display_version }}
          body: |
            ## Soju ${{ steps.version.outputs.display_version }}

            Wine built from source with custom patches for macOS.

            ### Components
            - **Wine** ${{ steps.version.outputs.wine_version }} (built from source)
            - **DXMT** ${{ env.DXMT_VERSION }} ([MIT license](https://github.com/3Shain/dxmt))
            - **DXVK** ${{ env.DXVK_VERSION }} ([zlib license](https://github.com/doitsujin/dxvk))
            - **CJK Fonts** (Korean, Japanese, Chinese support)

            ### Custom Patches
            - Window identifier for PodoSoju integration

            ### Installation
            Soju is automatically downloaded by the PodoSoju app on first launch.

            ### Build Info
            - Build type: Source build
            - Commit: ${{ github.sha }}

            ### License
            - Wine: LGPL 2.1+
            - DXMT: MIT
            - DXVK: zlib
          files: dist/*.tar.gz
          draft: false
          prerelease: ${{ contains(github.ref, 'rc') || contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
